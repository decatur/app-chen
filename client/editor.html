<!doctype html>
<html style="height: 100%;" lang="en">
<title>App Shell Editor</title>
<meta charset="utf-8"/>
<style>
    /*.CodeMirror {
        border-top: 1px solid black;
        border-bottom: 1px solid black;
        height: 100%;
    }*/
    button {
        font-weight: bold;
        font-size: large;
    }
</style>

<body style="height: 100%;">
<div style="height: 100%; display: flex; flex-direction: row;">
    <div style="height: 100%; display: flex; flex-direction: column;">
        <form name="displayToggleForm">
            <label><input name="showAll" type="checkbox">Show All</label>
        </form>
        <grid-chen class="modules" style="height: 100%;"></grid-chen>
    </div>
    <div style="flex: 1;">
        <form name="saveForm">
            <button title="Save Module" name="save">Save üêæ my Edits</button>
            as <input name="key">
        </form>
        <div id="code" style="height: 100%;"></div>
    </div>
</div>
</body>

<script type="module">

    import {handleError, responseToJSON, loadLegacyScript, initializeApp} from "./app.js"
    import "./grid-chen/webcomponent.js"
    import {createView} from "./grid-chen/matrixview.js"

    let editor = void 0;
    const styleSheet = document.createElement('style');
    styleSheet.textContent = '@import url("codemirror/lib/codemirror.css") screen; .CodeMirror {height: 100%;}';
    document.body.appendChild(styleSheet);
    loadLegacyScript(["codemirror/lib/codemirror.js", "codemirror/addon/edit/matchbrackets.js", "codemirror/mode/javascript/javascript.js"])
        .then(() => {
            editor = window['CodeMirror'](document.getElementById('code'), {
                lineNumbers: true,
                matchBrackets: true
            });
            if (window.location.hash.substr(1)) {
                fetchModule(window.location.hash.substr(1));
            }
        });

    const toggleForm = document.forms['displayToggleForm'];
    toggleForm.onsubmit = (event) => event.preventDefault();
    toggleForm.showAll.onchange = displayModules;

    const saveForm = document.forms['saveForm'];
    saveForm.onsubmit = (event) => event.preventDefault();

    saveForm.save.onclick = function () {
        const key = saveForm.key.value;
        fetch('/modules/' + key, {
            method: 'POST',
            headers: {'Content-Type': 'application/json; charset=utf-8'},
            body: JSON.stringify({code: editor.getValue()})
        })
            .then(responseToJSON)
            .then((response) => {
                // alert(JSON.stringify(response))
            })
            .catch(handleError);
    };

    /**
     * @param {HashChangeEvent} evt
     */
    window.onhashchange = function (evt) {
        fetchModule(window.location.hash.substr(1));
    };

    /**
     * @param {string} name
     */
    function fetchModule(name) {
        fetch('/modules/' + name)
            .then(responseToJSON)
            .then(module => {
                saveForm.key.value = name;
                editor.setValue(module.code);
            })
            .catch(handleError);
    }

    function displayNames() {
        const schema = {
            title: 'Modules',
            type: 'array',
            items: {
                type: 'object',
                properties: {
                    name: {title: 'Name', type: 'string', format: 'uri', width: 100}
                }
            }
        };
        const currentModulesByName = {};
        globalModules.forEach(module => {
            if (!(module.name in currentModulesByName)) {
                currentModulesByName[module.name] = module;
            }
        });
        document.querySelector('.modules').resetFromView(createView(schema, Object.values(currentModulesByName)));
    }

    function displayAll() {
        const schema = {
            title: 'Modules',
            type: 'array',
            items: {
                type: 'object',
                properties: {
                    name: {title: 'Name', type: 'string', format: 'uri', width: 100},
                    createAt: {title: 'Create At', type: 'string', format: 'date-time', frequency: 'MS', width: 300},
                    createBy: {title: 'Create By', type: 'string', width: 200},
                    id: {title: 'Id', type: 'string', width: 200}
                }
            }
        };
        document.querySelector('.modules').resetFromView(createView(schema, globalModules));
    }

    /** @type{object[]} */
    let globalModules = [];
    function addModule(module) {
        // grid-chen does not handle seconds and millis.
        //module.createAt = module.createAt.replace(/:\d\d\.\d+/, '');
        module.name = `[${module.name}](#${module.name})`;
        globalModules.unshift(module);
    }

    function displayModules() {
        if (toggleForm.showAll.checked) {
            displayAll();
        } else {
            displayNames();
        }
    }

    fetch('/modules')
        .then(responseToJSON)
        .then(modules => {
            modules.forEach(module => {
                addModule(module);
            });
            displayModules();
        })
        .catch(handleError);

    const app = initializeApp();
    app.register({
        'moduleChanged': function (event) {
            addModule(JSON.parse(event.data));
            displayModules();
        }
    });

</script>
</html>
